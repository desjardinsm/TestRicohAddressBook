version: "{build}"
skip_non_tags: true
environment:
  NuGetApiKey:
    secure: 23+pfmN1D6MWK5DKZNxxX1R3VxBJ/Dn8/wVzJWqV7RvJcBoffGEx96hfa/fPOHyW
install:
  - ps: Install-Module psake, Pester
build: false
test_script:
  - ps: |-
      Invoke-psake -buildFile ./psakefile.ps1 -taskList Test -nologo -notr

      if (-not $psake.build_success) {
        exit 1
      }
artifacts:
  - path: Module
    name: $(APPVEYOR_PROJECT_NAME)
before_deploy:
  - ps: Invoke-psake -buildFile ./psakefile.ps1 -taskList InitializeDeployments -nologo -notr
deploy:
  - provider: GitHub
    tag: $(APPVEYOR_REPO_TAG_NAME)
    description: $(RELEASE_DESCRIPTION)
    auth_token:
      secure: VCHxmBBb4C7d3FlTgQGh/A== # invalid token
    artifact: $(APPVEYOR_PROJECT_NAME)
    prerelease: $(IS_PRERELEASE)
    on:
      APPVEYOR_REPO_TAG: true
after_deploy:
  - ps: |-
      if ($env:APPVEYOR_REPO_TAG -eq $true -and $env:IS_PRERELEASE -eq $false) {
        Remove-Item -Recurse ./Publish/RicohAddressBook/ -ErrorAction Ignore
        Copy-Item -Recurse ./Module/ ./Publish/TestRicohAddressBook/

        Publish-Module -Path ./Publish/TestRicohAddressBook/ -NuGetApiKey $env:NuGetApiKey
      }
# on_finish:
#   # Upload test results on build finish (after_test will not run on a failed build)
#   - ps: |-
#       # Upload test results to AppVeyor
#       $client = [System.Net.WebClient]::new()
#       $results = Resolve-Path (Join-Path 'TestResults' 'testResults.xml')
#       $client.UploadFile("$env:APPVEYOR_URL/api/testresults/nunit3/$env:APPVEYOR_JOB_ID", $results)
